#!/usr/bin/env bash

sname=$0
HOST="localhost:9200"
VERBOSE=0
CURL_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null && pwd )"

function usage {
    printf "Usage: $sname [-dhvs] <script JSON path> <script name>\n"
    printf "  -d|--dir                 Directory that curl is run in\n"
    printf "  -h|--help                Display help\n"
    printf "  -v|--verbose             Verbose on\n"
    printf "  -s|--host                'Server:Port' string to store script on, defaults to 'localhost:9200'\n"
    exit $1
}

for flag in "$@"
do
case $flag in
    -s=*|--host=*)
    HOST="${flag#*=}"
    shift
    ;;
    -d=*|--dir=*)
    CURL_DIR="${flag#*=}"
    shift
    ;;
    -v|--verbose)
    VERBOSE=1
    shift
    ;;
    -h|--help)
    usage 0
    ;;
    *)

    ;;
esac
done

if [ "$#" -ge 2 ]; then
    if [[ -n $1 ]] && [[ -e $1 ]]; then
        script_path=$1
    else
        printf "ERROR: Script JSON must exist\n\n"
        usage 1
    fi
    if [[ -n $2 ]]; then
        script_name=$2
    else
        printf "ERROR: Script name must be specified\n\n"
        usage 1
    fi
else
    printf "ERROR: Script JSON path AND script name required\n\n"
    usage 1
fi

if [ "$VERBOSE" -eq 1 ]; then
    printf "\n\n"
    echo curl -H'Content-Type: application/json' -XPOST 'http://'"${HOST}"'/_scripts/'"${script_name}"
    printf "\n\n${script}\n\n"
    printf "Curl directory: ${CURL_DIR}\n\n"
fi

cd ${CURL_DIR}

curl -XPOST 'http://'"${HOST}"'/_scripts/'"${script_name}" -H'Content-Type: application/json' -d @"${script_path}"
